# 🎯 토스 빌링 + 크레딧 재지급 시스템 구현 전략

## 추천 방식: **동시 진행** ⚡

### 이유 1: 기존 토스 연동이 이미 완성도 높음
- ✅ 빌링키 발급/저장 로직 완료
- ✅ 자동결제 API 구현 완료  
- ✅ 웹훅 기본 구조 존재
- ✅ 결제 확인 로직 완료

### 이유 2: 웹훅은 기존 코드에 추가만 하면 됨
- 기존 `/api/webhooks/toss/route.ts` 파일 수정
- 새로운 함수 몇 개만 추가
- 기존 로직과 충돌 없음

### 이유 3: 테스트 효율성
- 실제 결제 → 웹훅 → 크레딧 지급까지 한 번에 검증
- 단계별로 나누면 각각 별도 테스트 필요

## 📋 3단계 동시 진행 계획

### Phase 1: 기반 구축 (30분)
**병렬 작업:**
- [ ] SQL 마이그레이션 실행
- [ ] 환경변수 TOSS_WEBHOOK_SECRET 추가
- [ ] 웹훅 핸들러 코드 업그레이드

### Phase 2: 토스 설정 + 테스트 (20분)  
**병렬 작업:**
- [ ] 토스 개발자센터 웹훅 등록
- [ ] 로컬 ngrok 테스트
- [ ] 웹훅 로그 확인

### Phase 3: 라이브 배포 + 검증 (10분)
**순차 작업:**
- [ ] Vercel 배포
- [ ] 실제 소액 결제 테스트  
- [ ] 크레딧 지급 확인

## ⚠️ 위험 요소 및 대응

### 기존 시스템 영향도: 매우 낮음
- 웹훅은 추가 기능 (기존 로직 변경 없음)
- 실패해도 기존 수동 크레딧 지급 방식 유지
- 롤백 쉬움 (웹훅 비활성화만 하면 됨)

### 테스트 안전성: 높음
- 샌드박스 환경 먼저 테스트
- 소액(100원) 실제 결제로 검증
- 단계별 로그 확인 가능

## 🚀 즉시 시작 가능한 이유

1. **기존 토스 연동 완성도**: 90%
2. **웹훅 추가 구현 복잡도**: 낮음
3. **테스트 환경 준비도**: 완료
4. **롤백 난이도**: 매우 쉬움

**결론: 지금 바로 동시 진행하는 것이 가장 효율적!**
